<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<div th:replace="~{usr/include/head :: head}"></div>


    <!-- Single Product Start -->
    <div class="container-fluid py-5 mt-5">
        <div class="container py-5">
            <div class="row g-4 mb-5">


                <div class="col">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="border rounded">
                                <img src="/usr/template/onlineMenuBoard/assets/img/margherita-pizza.jpg" class="img-fluid rounded" alt="Image">
                            </div>
                        </div>
                        <div class="col-lg-6">
							<input type="hidden" id="menu_seq" name="menu_seq" th:value="${item.seq}">
                            <h4 class="fw-bold mb-3" th:text="${item.menuNm}"></h4>
                            <h5 class="fw-bold mb-3" th:text="${#numbers.formatInteger(item.menuPrice, 3, 'COMMA')} + ' Ïõê'"></h5>
                            <div class="d-flex mb-4">
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star"></i>
                            </div>
                            <p class="mb-4" th:text="${item.menuDescription}"></p>

                            <div class="col p-3">
                                <div class="row bg-light align-items-center text-center justify-content-center py-2">
                                    <div class="col-6">
                                        <p class="mb-0">Ïó¥Îüâ(kcal)</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-0" th:text="${item.calories}"></p>
                                    </div>
                                </div>
                                <div class="row text-center align-items-center justify-content-center py-2">
                                    <div class="col-6">
                                        <p class="mb-0">ÎãπÎ•ò(g)</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-0" th:text="${item.sugars}"></p>
                                    </div>
                                </div>
                                <div class="row bg-light text-center align-items-center justify-content-center py-2">
                                    <div class="col-6">
                                        <p class="mb-0">Îã®Î∞±Ïßà(g)</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-0" th:text="${item.protein}"></p>
                                    </div>
                                </div>
                                <div class="row text-center align-items-center justify-content-center py-2">
                                    <div class="col-6">
                                        <p class="mb-0">Ìè¨ÌôîÏßÄÎ∞©(g)</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-0" th:text="${item.fat}"></p>
                                    </div>
                                </div>
                                <div class="row bg-light text-center align-items-center justify-content-center py-2">
                                    <div class="col-6">
                                        <p class="mb-0">ÎÇòÌä∏Î•®(mg)</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="mb-0" th:text="${item.sodium}"></p>
                                    </div>
                                </div>
                                
                            </div>

                        </div>

						<!-- ReviewList Start -->
						<div class="col-lg-12 ReviewList">
						
						    <h4 class="mb-4 border-bottom py-3">Î¶¨Î∑∞</h4>
						
						    <!-- Î¶¨Î∑∞ Î∞òÎ≥µ Ï∂úÎ†• -->
						    <div th:each="review : ${reviewList}" class="d-flex mb-4 border-bottom pb-3">
						        <div class="w-100">
						            <div class="d-flex justify-content-between align-items-center mb-1">
						                <h5 class="mb-0" th:text="${review.nickname}">ÎãâÎÑ§ÏûÑ</h5>
						                <p class="mb-0 text-muted" style="font-size: 14px;" th:text="${review.reviewDate}">ÏûëÏÑ±Ïùº</p>
						            </div>
						
						            <div class="mb-2">
						                <span th:each="i : ${#numbers.sequence(1, 5)}">
						                    <i class="fa fa-star" th:classappend="${i <= review.reviewRate} ? ' text-secondary' : ' text-muted'"></i>
						                </span>
						            </div>
						
						            <p class="mb-0" th:text="${review.reviewDescription}">Î¶¨Î∑∞ ÎÇ¥Ïö©</p>
						        </div>
						    </div>
						
						</div>
						<!-- ReviewList End -->

                        <!-- Writing Review Start -->
                        <form action="#">
                            <h4 class="mb-3 fw-bold">Î¶¨Î∑∞ ÎÇ®Í∏∞Í∏∞</h4>
                            <input type="hidden" id="user_seq" name="user_seq" th:value="${user.seq}">

                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <div class="border-bottom rounded">
                                        <input type="text" class="form-control border-0 me-4" th:value="${user.nickname}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="border-bottom rounded">
                                        <input type="email" class="form-control border-0" th:value="${user.email}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="border-bottom rounded my-3">
                                        <textarea name="" id="" class="form-control border-0" cols="30" rows="8"
                                            placeholder="ÎÇ¥Ïö© *" spellcheck="false"></textarea>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="d-flex justify-content-between py-3 mb-5">
                                        <div class="d-flex align-items-center">
                                            <p class="mb-0 me-3">ÌèâÏ†ê :</p>
                                            <!-- ÌèâÏ†ê ÏÑ†ÌÉù ÏòÅÏó≠ -->
											<div class="d-flex align-items-center">
											    <input type="hidden" id="reviewRate" value="0">
											    <i class="fa fa-star rating-star" data-rate="1"></i>
											    <i class="fa fa-star rating-star" data-rate="2"></i>
											    <i class="fa fa-star rating-star" data-rate="3"></i>
											    <i class="fa fa-star rating-star" data-rate="4"></i>
											    <i class="fa fa-star rating-star" data-rate="5"></i>
											</div>
                                        </div>
                                        <button type="button" 
                                        		id="btnSave" 
                                        		class="btn border border-secondary text-primary rounded-pill px-4 py-3">
                                        		Ï†ÄÏû•
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!-- Writing Review End -->

                    </div>
                </div>

            </div>

        </div>
    </div>
    <!-- Single Product End -->
    
<script>
document.addEventListener("DOMContentLoaded", function () {

	// Î≥ÑÏ†ê
    const stars = document.querySelectorAll('.rating-star');
    const reviewRateInput = document.getElementById('reviewRate');

    let selectedRating = 0; // Ïã§Ï†úÎ°ú ÏÑ†ÌÉùÎêú Î≥ÑÏ†ê

    // ‚≠ê Î≥ÑÏ†ê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    stars.forEach((star, index) => {
        const ratingValue = index + 1;

        // ÌÅ¥Î¶≠ - Ïã§Ï†ú ÏÑ†ÌÉùÎêú Î≥ÑÏ†ê ÏÑ§Ï†ï
        star.addEventListener('click', () => {
            selectedRating = ratingValue;
            reviewRateInput.value = selectedRating;
            updateStars(selectedRating);
        });

        // ÎßàÏö∞Ïä§ Ïò§Î≤Ñ - ÏûÑÏãúÎ°ú Î≥Ñ Ï±ÑÏõÄ
        star.addEventListener('mouseover', () => {
            updateStars(ratingValue);
        });

        // ÎßàÏö∞Ïä§ ÏïÑÏõÉ - Îã§Ïãú ÏÑ†ÌÉùÎêú Í∞íÏúºÎ°ú ÎêòÎèåÎ¶º
        star.addEventListener('mouseout', () => {
            updateStars(selectedRating);
        });
    });

    function updateStars(rate) {
        stars.forEach((star, i) => {
            if (i < rate) {
                star.classList.add('text-secondary');
            } else {
                star.classList.remove('text-secondary');
            }
        });
    }

    // üì§ Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ajax ÏöîÏ≤≠
    const saveBtn = document.getElementById('btnSave');

    saveBtn.addEventListener('click', function () {
        // 1. ÏûÖÎ†•Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
        const menuId = document.getElementById('menu_seq').value;
        const userId = document.getElementById('user_seq').value;
        const nickname = document.querySelector('input[type="text"]').value;
        const email = document.querySelector('input[type="email"]').value;
        const content = document.querySelector('textarea').value.trim();
        const rate = document.getElementById('reviewRate').value;

        // 2. ÏûÖÎ†• Ïïà ÌñàÏùÑ Îïå ÏïåÎ¶º
        if (!content || rate === "0") {
            alert("Î¶¨Î∑∞ ÎÇ¥Ïö©Í≥º ÌèâÏ†êÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }

        // 3. ÏÑúÎ≤ÑÏóê Î≥¥ÎÇº Ï†ïÎ≥¥
        const review = {
        	menu_seq: menuId,
            user_seq: userId,
            nickname: nickname,
            email: email,
            reviewDescription: content,
            reviewRate: rate
        };

        // 4. ÏÑúÎ≤ÑÏóê Ï†ÄÏû• ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
        fetch('/review/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(review)
        })
        .then(res => res.json())
        .then(newReview => {
            alert("Î¶¨Î∑∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");

            // 5. ÏÉà Î¶¨Î∑∞ ÌôîÎ©¥Ïóê Î≥¥Ïó¨Ï£ºÍ∏∞
            const box = document.createElement('div');
            box.className = 'd-flex mb-4 border-bottom pb-3';

            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<i class="fa fa-star ${i <= newReview.reviewRate ? 'text-secondary' : 'text-muted'}"></i>`;
            }

            box.innerHTML = `
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="mb-0">${newReview.nickname}</h5>
                        <p class="mb-0 text-muted" style="font-size: 14px;">${newReview.reviewDate}</p>
                    </div>
                    <div class="mb-2">${stars}</div>
                    <p class="mb-0">${newReview.reviewDescription}</p>
                </div>
            `;

            // 6. Ï†úÏùº ÏúÑÏóê Ï∂îÍ∞Ä
            
            const reviewListContainer = document.querySelector('.ReviewList');
			// Ï†úÎ™© h4 Îã§Ïùå ÏûêÏãù ÏöîÏÜå(Ï≤´ Î≤àÏß∏ Î¶¨Î∑∞ div) Î∞îÎ°ú Ï†ÑÏóê ÏÇΩÏûÖ
			const firstReview = reviewListContainer.querySelector('div.d-flex');
			
			if (firstReview) {
			    // Î¶¨Î∑∞Í∞Ä Ï°¥Ïû¨ÌïòÎ©¥ Í∑∏ ÏïûÏóê ÏÇΩÏûÖ
			    reviewListContainer.insertBefore(box, firstReview);
			} else {
			    // Î¶¨Î∑∞Í∞Ä ÌïòÎÇòÎèÑ ÏóÜÏúºÎ©¥, Ï†úÎ™©(h4) Îã§ÏùåÏóê Ï∂îÍ∞Ä
			    reviewListContainer.appendChild(box);
			}

            // 7. ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
            document.querySelector('textarea').value = '';
            document.getElementById('reviewRate').value = 0;
            document.querySelectorAll('.rating-star').forEach(star => star.classList.remove('text-secondary'));
        })
        .catch(err => {
            console.error(err);
            alert("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        });
    });
    
});
</script>

<div th:replace="~{usr/include/footer :: footer}"></div>